"Test IFC con Vistas de Planta, Elevación y Corte
@{html-ifc}
<!DOCTYPE html>
<html lang='es'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>IFC Viewer con Vistas - Silvia Cedeño.ifc</title>
    <style>
        /* ========== ESTILOS GENERALES ========== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #1a1a2e;
            color: #fff;
        }
        #ifc-viewer-main { width: 100%; height: 100%; position: relative; }
        #ifc-viewer-main-canvas { width: 100%; height: 100%; }
        @keyframes ifc-spin { to { transform: rotate(360deg); } }

        /* ========== BARRA DE HERRAMIENTAS ========== */
        .toolbar {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 5px;
            background: rgba(0,0,0,0.85);
            padding: 8px 12px;
            border-radius: 8px;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .toolbar button {
            background: #2d2d44;
            color: #fff;
            border: 1px solid #444;
            padding: 8px 14px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .toolbar button:hover {
            background: #3d3d5c;
            border-color: #0078d4;
        }
        .toolbar button.active {
            background: #0078d4;
            border-color: #0078d4;
        }
        .toolbar button svg {
            width: 16px;
            height: 16px;
        }
        .toolbar-separator {
            width: 1px;
            background: #444;
            margin: 0 5px;
        }

        /* ========== PANEL DE CORTE ========== */
        .section-panel {
            position: absolute;
            top: 60px;
            right: 10px;
            background: rgba(0,0,0,0.85);
            padding: 12px;
            border-radius: 8px;
            width: 200px;
            display: none;
            z-index: 100;
        }
        .section-panel.visible { display: block; }
        .section-panel h4 {
            margin-bottom: 10px;
            font-size: 13px;
            color: #0078d4;
        }
        .section-panel label {
            display: block;
            font-size: 11px;
            margin-bottom: 4px;
            color: #aaa;
        }
        .section-panel input[type="range"] {
            width: 100%;
            margin-bottom: 10px;
        }
        .section-panel .value-display {
            font-size: 11px;
            color: #fff;
            text-align: right;
            margin-top: -8px;
            margin-bottom: 8px;
        }

        /* ========== PANEL DE NIVELES ========== */
        .levels-panel {
            position: absolute;
            top: 60px;
            left: 10px;
            background: rgba(0,0,0,0.85);
            padding: 12px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 100;
            min-width: 150px;
        }
        .levels-panel.visible { display: block; }
        .levels-panel h4 {
            margin-bottom: 10px;
            font-size: 13px;
            color: #0078d4;
        }
        .level-item {
            padding: 6px 10px;
            margin: 2px 0;
            background: #2d2d44;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
        }
        .level-item:hover { background: #3d3d5c; }
        .level-item.active { background: #0078d4; }

        /* ========== INFO PANEL ========== */
        .info-panel {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.85);
            color: #fff;
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 11px;
            max-width: 250px;
        }
        .info-panel strong {
            color: #0078d4;
            font-size: 13px;
        }
        .info-panel .view-mode {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #333;
            color: #888;
        }

        /* ========== CONTROLES ========== */
        .controls-panel {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.85);
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 10px;
            color: #888;
        }
        .controls-panel kbd {
            background: #333;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            color: #fff;
        }

        /* ========== LOADING ========== */
        .loading-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(26, 26, 46, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #333;
            border-top-color: #0078d4;
            border-radius: 50%;
            animation: ifc-spin 1s linear infinite;
        }
        .progress-bar {
            width: 200px;
            height: 6px;
            background: #333;
            border-radius: 3px;
            margin-top: 15px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #0078d4, #00b4d8);
            width: 0%;
            transition: width 0.3s;
        }
        .loading-text {
            margin-top: 15px;
            color: #888;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div id="ifc-viewer-main">
        <canvas id="ifc-viewer-main-canvas"></canvas>

        <!-- BARRA DE HERRAMIENTAS PRINCIPAL -->
        <div class="toolbar">
            <button id="btn-3d" class="active" title="Vista 3D Isométrica">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
                3D
            </button>
            <div class="toolbar-separator"></div>
            <button id="btn-top" title="Vista de Planta (Top)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                    <path d="M12 8v8M8 12h8"/>
                </svg>
                Planta
            </button>
            <button id="btn-front" title="Vista Frontal (Elevación)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="5" width="18" height="14" rx="2"/>
                    <path d="M3 10h18"/>
                </svg>
                Frontal
            </button>
            <button id="btn-right" title="Vista Lateral Derecha">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="5" y="3" width="14" height="18" rx="2"/>
                    <path d="M10 3v18"/>
                </svg>
                Lateral
            </button>
            <div class="toolbar-separator"></div>
            <button id="btn-section" title="Plano de Corte">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 12h16M12 4v16"/>
                    <circle cx="12" cy="12" r="3"/>
                </svg>
                Corte
            </button>
            <button id="btn-levels" title="Niveles/Pisos">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 6h18M3 12h18M3 18h18"/>
                </svg>
                Niveles
            </button>
            <div class="toolbar-separator"></div>
            <button id="btn-fit" title="Ajustar Vista (F)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/>
                </svg>
                Fit
            </button>
        </div>

        <!-- PANEL DE CORTE -->
        <div id="section-panel" class="section-panel">
            <h4>Plano de Corte</h4>
            <label>Eje X</label>
            <input type="range" id="section-x" min="-100" max="100" value="0">
            <div class="value-display" id="section-x-value">0.0 m</div>

            <label>Eje Y (Altura)</label>
            <input type="range" id="section-y" min="-100" max="100" value="0">
            <div class="value-display" id="section-y-value">0.0 m</div>

            <label>Eje Z</label>
            <input type="range" id="section-z" min="-100" max="100" value="0">
            <div class="value-display" id="section-z-value">0.0 m</div>

            <div style="margin-top: 10px;">
                <button id="btn-reset-section" style="width: 100%; padding: 6px; background: #444; border: none; color: #fff; border-radius: 4px; cursor: pointer;">
                    Resetear Corte
                </button>
            </div>
        </div>

        <!-- PANEL DE NIVELES -->
        <div id="levels-panel" class="levels-panel">
            <h4>Niveles Detectados</h4>
            <div id="levels-list">
                <div class="level-item active" data-level="all">Todos los niveles</div>
            </div>
        </div>

        <!-- INFO PANEL -->
        <div class="info-panel">
            <strong>Silvia Cedeño.ifc</strong>
            <div id="ifc-stats"></div>
            <div class="view-mode">
                Vista: <span id="current-view">3D Isométrica</span>
            </div>
        </div>

        <!-- CONTROLES -->
        <div class="controls-panel">
            <p><kbd>Click + Arrastrar</kbd> Rotar</p>
            <p><kbd>Scroll</kbd> Zoom</p>
            <p><kbd>F</kbd> Fit to view</p>
            <p><kbd>1-4</kbd> Cambiar vista</p>
        </div>

        <!-- LOADING -->
        <div id="loading-overlay" class="loading-overlay">
            <div class="spinner"></div>
            <div class="progress-bar">
                <div class="progress-bar-fill" id="progress-fill"></div>
            </div>
            <p class="loading-text" id="loading-text">Inicializando...</p>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://calcpad.ifc/three.min.js"></script>
    <script src="https://calcpad.ifc/OrbitControls.js"></script>
    <script src="https://calcpad.ifc/web-ifc-api-iife.js"></script>
    <script>
    (async function() {
        // ========== ELEMENTOS DOM ==========
        const canvas = document.getElementById('ifc-viewer-main-canvas');
        const container = document.getElementById('ifc-viewer-main');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const progressFill = document.getElementById('progress-fill');
        const statsEl = document.getElementById('ifc-stats');
        const currentViewEl = document.getElementById('current-view');
        const sectionPanel = document.getElementById('section-panel');
        const levelsPanel = document.getElementById('levels-panel');
        const levelsList = document.getElementById('levels-list');

        // ========== ESTADO GLOBAL ==========
        let scene, camera, orthoCamera, renderer, controls;
        let allMeshes, boundingBox, center, maxDim;
        let currentView = '3d';
        let clippingPlanes = {
            x: null,
            y: null,
            z: null
        };
        let clippingEnabled = false;
        let detectedLevels = [];

        function updateProgress(msg, pct) {
            loadingText.textContent = msg;
            progressFill.style.width = pct + '%';
        }

        try {
            updateProgress('Inicializando Three.js...', 10);

            // ========== ESCENA 3D ==========
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a2e);

            // Cámara Perspectiva (para vista 3D)
            camera = new THREE.PerspectiveCamera(
                60,
                container.clientWidth / container.clientHeight,
                0.1,
                10000
            );
            camera.position.set(50, 50, 50);

            // Cámara Ortográfica (para vistas 2D)
            const aspect = container.clientWidth / container.clientHeight;
            orthoCamera = new THREE.OrthographicCamera(
                -50 * aspect, 50 * aspect,
                50, -50,
                0.1, 10000
            );

            // Renderer
            renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.localClippingEnabled = true; // Habilitar clipping

            // Controles
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;

            // ========== ILUMINACIÓN ==========
            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
            const dirLight1 = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight1.position.set(50, 100, 50);
            scene.add(dirLight1);
            const dirLight2 = new THREE.DirectionalLight(0xffffff, 0.4);
            dirLight2.position.set(-50, 50, -50);
            scene.add(dirLight2);

            // Grid
            const gridHelper = new THREE.GridHelper(200, 200, 0x444444, 0x333333);
            scene.add(gridHelper);

            // ========== CARGAR IFC ==========
            updateProgress('Descargando archivo IFC...', 20);
            const response = await fetch('https://calcpad.ifc/temp_a7ce813c013e4fc48bd57558ccf7ebd6.ifc');
            if (!response.ok) throw new Error('Error descargando: ' + response.status);

            updateProgress('Leyendo datos...', 40);
            const ifcData = await response.arrayBuffer();

            updateProgress('Inicializando web-ifc...', 50);
            const ifcApi = new WebIFC.IfcAPI();
            await ifcApi.Init(path => path.endsWith('.wasm') ? 'https://calcpad.ifc/' + path : path);

            updateProgress('Parseando modelo IFC...', 60);
            const modelID = ifcApi.OpenModel(new Uint8Array(ifcData));

            // Detectar niveles (IfcBuildingStorey)
            try {
                const storeys = ifcApi.GetLineIDsWithType(modelID, WebIFC.IFCBUILDINGSTOREY);
                for (let i = 0; i < storeys.size(); i++) {
                    const storeyID = storeys.get(i);
                    const storey = ifcApi.GetLine(modelID, storeyID);
                    if (storey && storey.Elevation) {
                        detectedLevels.push({
                            id: storeyID,
                            name: storey.Name ? storey.Name.value : 'Nivel ' + (i + 1),
                            elevation: storey.Elevation.value || 0
                        });
                    }
                }
                detectedLevels.sort((a, b) => a.elevation - b.elevation);
            } catch (e) {
                console.log('No se pudieron detectar niveles:', e);
            }

            updateProgress('Generando geometría 3D...', 70);
            const flatMeshes = ifcApi.LoadAllGeometry(modelID);

            updateProgress('Construyendo mallas...', 80);
            allMeshes = new THREE.Group();
            let meshCount = 0;
            let triangleCount = 0;
            let minY = Infinity, maxY = -Infinity;

            for (let i = 0; i < flatMeshes.size(); i++) {
                const flatMesh = flatMeshes.get(i);
                const placedGeometries = flatMesh.geometries;

                for (let j = 0; j < placedGeometries.size(); j++) {
                    const pg = placedGeometries.get(j);
                    const geom = ifcApi.GetGeometry(modelID, pg.geometryExpressID);

                    const verts = ifcApi.GetVertexArray(geom.GetVertexData(), geom.GetVertexDataSize());
                    const indices = ifcApi.GetIndexArray(geom.GetIndexData(), geom.GetIndexDataSize());

                    if (verts.length === 0 || indices.length === 0) continue;

                    const positions = new Float32Array(verts.length / 2);
                    const normals = new Float32Array(verts.length / 2);
                    for (let k = 0; k < verts.length; k += 6) {
                        const idx = (k / 6) * 3;
                        positions[idx] = verts[k];
                        positions[idx + 1] = verts[k + 1];
                        positions[idx + 2] = verts[k + 2];
                        normals[idx] = verts[k + 3];
                        normals[idx + 1] = verts[k + 4];
                        normals[idx + 2] = verts[k + 5];

                        // Track Y range
                        if (verts[k + 1] < minY) minY = verts[k + 1];
                        if (verts[k + 1] > maxY) maxY = verts[k + 1];
                    }

                    const bufferGeom = new THREE.BufferGeometry();
                    bufferGeom.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                    bufferGeom.setAttribute('normal', new THREE.BufferAttribute(normals, 3));
                    bufferGeom.setIndex(new THREE.BufferAttribute(indices, 1));

                    const color = new THREE.Color(pg.color.x, pg.color.y, pg.color.z);
                    const material = new THREE.MeshPhongMaterial({
                        color: color,
                        side: THREE.DoubleSide,
                        transparent: pg.color.w < 1,
                        opacity: pg.color.w,
                        clippingPlanes: [] // Se llenará después
                    });

                    const meshObj = new THREE.Mesh(bufferGeom, material);
                    meshObj.userData.expressID = flatMesh.expressID;
                    const matrix = new THREE.Matrix4().fromArray(pg.flatTransformation);
                    meshObj.applyMatrix4(matrix);
                    allMeshes.add(meshObj);
                    meshCount++;
                    triangleCount += indices.length / 3;
                }
            }

            scene.add(allMeshes);

            // ========== AJUSTAR VISTA ==========
            updateProgress('Ajustando vista...', 90);
            boundingBox = new THREE.Box3().setFromObject(allMeshes);
            center = boundingBox.getCenter(new THREE.Vector3());
            const size = boundingBox.getSize(new THREE.Vector3());
            maxDim = Math.max(size.x, size.y, size.z);

            camera.position.set(center.x + maxDim, center.y + maxDim * 0.7, center.z + maxDim);
            controls.target.copy(center);
            controls.update();

            // Configurar sliders de corte
            const sectionX = document.getElementById('section-x');
            const sectionY = document.getElementById('section-y');
            const sectionZ = document.getElementById('section-z');

            sectionX.min = boundingBox.min.x.toFixed(0);
            sectionX.max = boundingBox.max.x.toFixed(0);
            sectionX.value = boundingBox.max.x.toFixed(0);

            sectionY.min = boundingBox.min.y.toFixed(0);
            sectionY.max = boundingBox.max.y.toFixed(0);
            sectionY.value = boundingBox.max.y.toFixed(0);

            sectionZ.min = boundingBox.min.z.toFixed(0);
            sectionZ.max = boundingBox.max.z.toFixed(0);
            sectionZ.value = boundingBox.max.z.toFixed(0);

            // Actualizar lista de niveles
            if (detectedLevels.length > 0) {
                detectedLevels.forEach((level, idx) => {
                    const div = document.createElement('div');
                    div.className = 'level-item';
                    div.dataset.level = idx;
                    div.dataset.elevation = level.elevation;
                    div.textContent = level.name + ' (' + level.elevation.toFixed(2) + 'm)';
                    levelsList.appendChild(div);
                });
            }

            // Ocultar loading
            loadingOverlay.style.display = 'none';
            statsEl.innerHTML = '<br>' + meshCount + ' elementos<br>' +
                               Math.round(triangleCount / 1000) + 'k triángulos';

            ifcApi.CloseModel(modelID);

            // ========== FUNCIONES DE VISTA ==========
            function setView(viewType) {
                currentView = viewType;

                // Desactivar todos los botones
                document.querySelectorAll('.toolbar button').forEach(b => b.classList.remove('active'));

                const dist = maxDim * 2;

                switch(viewType) {
                    case '3d':
                        document.getElementById('btn-3d').classList.add('active');
                        controls.object = camera;
                        camera.position.set(center.x + maxDim, center.y + maxDim * 0.7, center.z + maxDim);
                        controls.target.copy(center);
                        controls.enableRotate = true;
                        currentViewEl.textContent = '3D Isométrica';
                        break;

                    case 'top':
                        document.getElementById('btn-top').classList.add('active');
                        updateOrthoCamera(dist);
                        controls.object = orthoCamera;
                        orthoCamera.position.set(center.x, center.y + dist, center.z);
                        orthoCamera.up.set(0, 0, -1);
                        controls.target.copy(center);
                        controls.enableRotate = false;
                        currentViewEl.textContent = 'Planta (Top)';
                        break;

                    case 'front':
                        document.getElementById('btn-front').classList.add('active');
                        updateOrthoCamera(dist);
                        controls.object = orthoCamera;
                        orthoCamera.position.set(center.x, center.y, center.z + dist);
                        orthoCamera.up.set(0, 1, 0);
                        controls.target.copy(center);
                        controls.enableRotate = false;
                        currentViewEl.textContent = 'Frontal (Elevación)';
                        break;

                    case 'right':
                        document.getElementById('btn-right').classList.add('active');
                        updateOrthoCamera(dist);
                        controls.object = orthoCamera;
                        orthoCamera.position.set(center.x + dist, center.y, center.z);
                        orthoCamera.up.set(0, 1, 0);
                        controls.target.copy(center);
                        controls.enableRotate = false;
                        currentViewEl.textContent = 'Lateral Derecha';
                        break;
                }

                controls.update();
            }

            function updateOrthoCamera(size) {
                const aspect = container.clientWidth / container.clientHeight;
                orthoCamera.left = -size * aspect;
                orthoCamera.right = size * aspect;
                orthoCamera.top = size;
                orthoCamera.bottom = -size;
                orthoCamera.updateProjectionMatrix();
            }

            function fitToView() {
                const dist = maxDim * (currentView === '3d' ? 1.5 : 2);

                if (currentView === '3d') {
                    camera.position.set(center.x + maxDim, center.y + maxDim * 0.7, center.z + maxDim);
                } else {
                    setView(currentView);
                }
                controls.target.copy(center);
                controls.update();
            }

            function updateClipping() {
                const planes = [];

                if (clippingEnabled) {
                    const xVal = parseFloat(sectionX.value);
                    const yVal = parseFloat(sectionY.value);
                    const zVal = parseFloat(sectionZ.value);

                    // Crear planos de corte
                    if (xVal < boundingBox.max.x - 0.1) {
                        planes.push(new THREE.Plane(new THREE.Vector3(-1, 0, 0), xVal));
                    }
                    if (yVal < boundingBox.max.y - 0.1) {
                        planes.push(new THREE.Plane(new THREE.Vector3(0, -1, 0), yVal));
                    }
                    if (zVal < boundingBox.max.z - 0.1) {
                        planes.push(new THREE.Plane(new THREE.Vector3(0, 0, -1), zVal));
                    }

                    document.getElementById('section-x-value').textContent = xVal.toFixed(1) + ' m';
                    document.getElementById('section-y-value').textContent = yVal.toFixed(1) + ' m';
                    document.getElementById('section-z-value').textContent = zVal.toFixed(1) + ' m';
                }

                // Aplicar a todos los materiales
                allMeshes.traverse(obj => {
                    if (obj.isMesh && obj.material) {
                        obj.material.clippingPlanes = planes;
                        obj.material.needsUpdate = true;
                    }
                });
            }

            // ========== EVENT LISTENERS ==========
            document.getElementById('btn-3d').addEventListener('click', () => setView('3d'));
            document.getElementById('btn-top').addEventListener('click', () => setView('top'));
            document.getElementById('btn-front').addEventListener('click', () => setView('front'));
            document.getElementById('btn-right').addEventListener('click', () => setView('right'));
            document.getElementById('btn-fit').addEventListener('click', fitToView);

            document.getElementById('btn-section').addEventListener('click', function() {
                this.classList.toggle('active');
                clippingEnabled = this.classList.contains('active');
                sectionPanel.classList.toggle('visible', clippingEnabled);
                updateClipping();
            });

            document.getElementById('btn-levels').addEventListener('click', function() {
                this.classList.toggle('active');
                levelsPanel.classList.toggle('visible');
            });

            document.getElementById('btn-reset-section').addEventListener('click', () => {
                sectionX.value = boundingBox.max.x;
                sectionY.value = boundingBox.max.y;
                sectionZ.value = boundingBox.max.z;
                updateClipping();
            });

            sectionX.addEventListener('input', updateClipping);
            sectionY.addEventListener('input', updateClipping);
            sectionZ.addEventListener('input', updateClipping);

            // Click en niveles
            levelsList.addEventListener('click', (e) => {
                if (e.target.classList.contains('level-item')) {
                    document.querySelectorAll('.level-item').forEach(l => l.classList.remove('active'));
                    e.target.classList.add('active');

                    const level = e.target.dataset.level;
                    if (level === 'all') {
                        // Mostrar todo
                        sectionY.value = boundingBox.max.y;
                        updateClipping();
                    } else {
                        // Corte a la altura del nivel
                        const elevation = parseFloat(e.target.dataset.elevation);
                        sectionY.value = elevation + 3; // 3m sobre el nivel

                        // Activar corte si no está activo
                        if (!clippingEnabled) {
                            document.getElementById('btn-section').click();
                        } else {
                            updateClipping();
                        }

                        // Cambiar a vista de planta
                        setView('top');
                    }
                }
            });

            // Teclado
            document.addEventListener('keydown', (e) => {
                switch(e.key.toLowerCase()) {
                    case 'f': fitToView(); break;
                    case '1': setView('3d'); break;
                    case '2': setView('top'); break;
                    case '3': setView('front'); break;
                    case '4': setView('right'); break;
                }
            });

            // Resize
            window.addEventListener('resize', () => {
                const aspect = container.clientWidth / container.clientHeight;
                camera.aspect = aspect;
                camera.updateProjectionMatrix();
                updateOrthoCamera(maxDim * 2);
                renderer.setSize(container.clientWidth, container.clientHeight);
            });

            // ========== ANIMACIÓN ==========
            function animate() {
                requestAnimationFrame(animate);
                controls.update();
                const activeCamera = currentView === '3d' ? camera : orthoCamera;
                renderer.render(scene, activeCamera);
            }
            animate();

        } catch (error) {
            console.error('Error:', error);
            loadingText.textContent = 'Error: ' + error.message;
            loadingText.style.color = '#ff6b6b';
        }
    })();
    </script>
</body>
</html>
@{end html-ifc}
