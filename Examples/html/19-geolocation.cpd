"============================================
"üìç GEOLOCATION API - UBICACI√ìN DEL USUARIO
"============================================
"Aprende a obtener la ubicaci√≥n geogr√°fica del usuario.

"¬øQU√â ES GEOLOCATION API?
"----------------------------------------
'API del navegador para obtener coordenadas GPS
'Requiere PERMISO del usuario (seguridad)
'Funciona en: desktop, m√≥viles, tablets
'Retorna: latitud, longitud, precisi√≥n

"M√âTODOS PRINCIPALES
"----------------------------------------
'getCurrentPosition() - Obtener ubicaci√≥n una vez
'watchPosition() - Monitorear cambios de ubicaci√≥n
'clearWatch() - Dejar de monitorear

"PRECISI√ìN
"----------------------------------------
'GPS (m√≥vil): ~5-50 metros
'WiFi: ~20-100 metros
'IP: ~1-100 km (muy imprecisa)

@{html}
<!DOCTYPE html>
<html lang="es">

<!-- #region HEAD -->
<head>
  <meta charset="UTF-8">
  <title>19 - Geolocation API</title>

  <!-- #region ESTILOS -->
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    h1 {
      text-align: center;
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .seccion {
      background: white;
      padding: 30px;
      margin: 20px auto;
      max-width: 800px;
      border-radius: 8px;
    }

    button {
      background: #2196f3;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px;
    }

    button:hover {
      background: #1976d2;
    }

    #mapa {
      width: 100%;
      height: 400px;
      border-radius: 8px;
      margin: 20px 0;
    }

    .info-card {
      background: #e3f2fd;
      padding: 20px;
      border-radius: 8px;
      margin: 10px 0;
      border-left: 4px solid #2196f3;
    }

    .coordenada {
      font-size: 24px;
      font-weight: bold;
      color: #2196f3;
    }

    .error {
      background: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #f44336;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
  </style>
  <!-- #endregion -->
</head>
<!-- #endregion -->

<!-- #region BODY -->
<body>
  <h1>üìç Geolocation API</h1>

  <!-- #region OBTENER UBICACI√ìN -->
  <div class="seccion">
    <h2>üåç Tu Ubicaci√≥n</h2>
    <p>Haz click para obtener tu ubicaci√≥n GPS</p>

    <button onclick="obtenerUbicacion()">üìç Obtener Mi Ubicaci√≥n</button>
    <button onclick="watchUbicacion()">üëÅÔ∏è Monitorear Ubicaci√≥n</button>
    <button onclick="stopWatch()">‚èπÔ∏è Detener Monitoreo</button>

    <div id="resultado"></div>

    <!-- Mapa (OpenStreetMap) -->
    <iframe id="mapa" style="display: none;"
            frameborder="0" scrolling="no" marginheight="0" marginwidth="0">
    </iframe>
  </div>
  <!-- #endregion -->

  <!-- #region INFORMACI√ìN -->
  <div class="seccion">
    <h3>‚ÑπÔ∏è Informaci√≥n Importante:</h3>
    <ul>
      <li>üîí El navegador pedir√° tu permiso para acceder a la ubicaci√≥n</li>
      <li>üì± En m√≥viles la precisi√≥n es mejor (GPS)</li>
      <li>üíª En desktop usa WiFi o IP (menos preciso)</li>
      <li>üåê Requiere HTTPS en producci√≥n (no en localhost)</li>
    </ul>
  </div>
  <!-- #endregion -->

  <!-- #region SCRIPTS -->
  <script>
    // #region VARIABLE GLOBAL
    let watchId = null;
    // #endregion

    // #region OBTENER UBICACI√ìN UNA VEZ
    function obtenerUbicacion() {
      const resultado = document.getElementById('resultado');

      if (!navigator.geolocation) {
        resultado.innerHTML = '<div class="error">‚ùå Tu navegador no soporta Geolocation</div>';
        return;
      }

      resultado.innerHTML = '<div class="loading">‚è≥ Obteniendo ubicaci√≥n...</div>';

      navigator.geolocation.getCurrentPosition(
        // √âxito
        (position) => {
          mostrarUbicacion(position);
        },
        // Error
        (error) => {
          mostrarError(error);
        },
        // Opciones
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    }
    // #endregion

    // #region MONITOREAR UBICACI√ìN
    function watchUbicacion() {
      const resultado = document.getElementById('resultado');

      if (!navigator.geolocation) {
        resultado.innerHTML = '<div class="error">‚ùå Tu navegador no soporta Geolocation</div>';
        return;
      }

      resultado.innerHTML = '<div class="loading">üëÅÔ∏è Monitoreando ubicaci√≥n...</div>';

      watchId = navigator.geolocation.watchPosition(
        (position) => {
          mostrarUbicacion(position, true);
        },
        (error) => {
          mostrarError(error);
        },
        {
          enableHighAccuracy: true,
          timeout: 5000,
          maximumAge: 0
        }
      );
    }
    // #endregion

    // #region DETENER MONITOREO
    function stopWatch() {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
        document.getElementById('resultado').innerHTML += '<p>‚èπÔ∏è Monitoreo detenido</p>';
      }
    }
    // #endregion

    // #region MOSTRAR UBICACI√ìN
    function mostrarUbicacion(position, isWatch = false) {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;
      const precision = position.coords.accuracy;
      const timestamp = new Date(position.timestamp);

      const html = `
        <div class="info-card">
          <h3>${isWatch ? 'üëÅÔ∏è Ubicaci√≥n Actualizada' : 'üìç Tu Ubicaci√≥n'}</h3>
          <p><strong>Latitud:</strong> <span class="coordenada">${lat.toFixed(6)}</span></p>
          <p><strong>Longitud:</strong> <span class="coordenada">${lon.toFixed(6)}</span></p>
          <p><strong>Precisi√≥n:</strong> ¬±${precision.toFixed(0)} metros</p>
          <p><strong>Hora:</strong> ${timestamp.toLocaleTimeString()}</p>
          <a href="https://www.google.com/maps?q=${lat},${lon}" target="_blank">
            üìç Ver en Google Maps
          </a>
        </div>
      `;

      document.getElementById('resultado').innerHTML = html;

      // Mostrar en mapa
      const mapa = document.getElementById('mapa');
      mapa.src = `https://www.openstreetmap.org/export/embed.html?bbox=${lon-0.01},${lat-0.01},${lon+0.01},${lat+0.01}&layer=mapnik&marker=${lat},${lon}`;
      mapa.style.display = 'block';
    }
    // #endregion

    // #region MOSTRAR ERROR
    function mostrarError(error) {
      let mensaje = '';

      switch(error.code) {
        case error.PERMISSION_DENIED:
          mensaje = '‚ùå Usuario deneg√≥ el permiso de geolocalizaci√≥n';
          break;
        case error.POSITION_UNAVAILABLE:
          mensaje = '‚ùå Informaci√≥n de ubicaci√≥n no disponible';
          break;
        case error.TIMEOUT:
          mensaje = '‚ùå Tiempo de espera agotado';
          break;
        default:
          mensaje = '‚ùå Error desconocido';
      }

      document.getElementById('resultado').innerHTML = `<div class="error">${mensaje}</div>`;
    }
    // #endregion

    console.log('‚úÖ Geolocation API demo cargado');
    console.log('üìç Geolocation soportado:', 'geolocation' in navigator);
  </script>
  <!-- #endregion -->

</body>
<!-- #endregion -->

</html>
@{end html}
