"Color Map FEM - Estructura Awatif-UI
'Replica la estructura de awatif-ui/src/color-map:
'- getColorMap.ts (funcion para crear mesh con colores)
'- getLegend.ts (funcion para crear leyenda)
'- main.ts (punto de entrada)
'- styles.css (estilos)
'- index.html (pagina principal)

"1. Datos FEM
nodos = 4
elementos = 2
'Desplazamientos nodales (mm):
d_1 = 0
d_2 = 2.5
d_3 = 10
d_4 = 5

"========================================
"2. getColorMap.ts - Funcion Color Map
"========================================
@{ts}
// getColorMap.ts - Crea mesh con vertex colors basado en valores

interface ColorMapConfig {
    nodes: number[][];
    elements: number[][];
    values: number[];
}

function getColorMap(config: ColorMapConfig) {
    const { nodes, elements, values } = config;
    const minVal = Math.min(...values);
    const maxVal = Math.max(...values);

    console.log("=== getColorMap.ts ===");
    console.log(`Creando color map para ${nodes.length} nodos`);
    console.log(`Rango de valores: [${minVal}, ${maxVal}]`);

    // Calcular colores usando LUT rainbow
    const colors = values.map((v, i) => {
        const t = (v - minVal) / (maxVal - minVal || 1);
        let r: number, g: number, b: number;

        if (t < 0.25) { r = 0; g = t * 4; b = 1; }
        else if (t < 0.5) { r = 0; g = 1; b = 1 - (t - 0.25) * 4; }
        else if (t < 0.75) { r = (t - 0.5) * 4; g = 1; b = 0; }
        else { r = 1; g = 1 - (t - 0.75) * 4; b = 0; }

        return { r, g, b, hex: `#${Math.round(r*255).toString(16).padStart(2,'0')}${Math.round(g*255).toString(16).padStart(2,'0')}${Math.round(b*255).toString(16).padStart(2,'0')}` };
    });

    colors.forEach((c, i) => console.log(`  Nodo ${i}: valor=${values[i].toFixed(1)} -> color=${c.hex}`));

    return { nodes, elements, colors, minVal, maxVal };
}

// Test
const colorMap = getColorMap({
    nodes: [[0,0,0], [5,0,0], [5,0,5], [0,0,5]],
    elements: [[0,1,2], [0,2,3]],
    values: [0, 2.5, 10, 5]
});
@{end ts}

"========================================
"3. getLegend.ts - Funcion Leyenda
"========================================
@{ts}
// getLegend.ts - Crea leyenda con marcadores de valores

function getLegend(minVal: number, maxVal: number, numMarkers: number = 5) {
    console.log("\n=== getLegend.ts ===");
    console.log(`Creando leyenda: min=${minVal}, max=${maxVal}`);

    const markers: { ratio: number; value: string }[] = [];

    for (let i = 0; i < numMarkers; i++) {
        const ratio = i / (numMarkers - 1);
        const value = (maxVal - (maxVal - minVal) * ratio).toFixed(1);
        markers.push({ ratio, value });
        console.log(`  Marker ${i}: ${value}`);
    }

    return markers;
}

// Test
const legend = getLegend(0, 10, 5);
@{end ts}

"========================================
"4. main.ts - Punto de Entrada
"========================================
@{ts}
// main.ts - Combina colorMap + legend + viewer

console.log("\n=== main.ts ===");
console.log("Inicializando aplicacion Color Map FEM...");

// Datos de la malla (en awatif usa van.state para reactividad)
const nodes = [[0,0,0], [5,0,0], [5,0,5], [0,0,5]];
const elements = [[0,1,2], [0,2,3]];
const values = [0, 2.5, 10, 5];

console.log(`Nodos: ${nodes.length}`);
console.log(`Elementos: ${elements.length}`);
console.log(`Valores: [${values.join(', ')}]`);

// Simular actualizacion reactiva (como setTimeout en awatif)
console.log("\nSimulando actualizacion de valores...");
const newValues = [1, 5, 0, 8];
console.log(`Nuevos valores: [${newValues.join(', ')}]`);

console.log("\n>> Componentes listos para renderizar en Three.js");
@{end ts}

"========================================
"5. styles.css - Estilos
"========================================
@{css}
/* styles.css - Estilos para color-map */

#legend {
    width: 20px;
    height: 200px;
    background: linear-gradient(
        #ff0000,
        #ffff00 25%,
        #00ff00 50%,
        #00ffff 75%,
        #0000ff
    );
    position: absolute;
    right: 50px;
    top: 100px;
    z-index: 2;
}

#legend .marker {
    width: 10px;
    height: 1px;
    margin-left: 20px;
    background: white;
    position: relative;
}

#legend .marker p {
    position: absolute;
    color: white;
    font-size: 12px;
    top: -7px;
    left: 15px;
    margin: 0;
    font-family: monospace;
}

#container {
    width: 100%;
    height: 400px;
    background: #1a1a2e;
}
@{end css}

"========================================
"6. index.html - Visualizador 3D
"========================================
@{html:embed}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Awatif UI - Color Map</title>
    <style>
        body { margin: 0; background: #1a1a2e; }
        #container { width: 100%; height: 380px; }
        #legend {
            width: 20px; height: 200px;
            background: linear-gradient(#ff0000, #ffff00 25%, #00ff00 50%, #00ffff 75%, #0000ff);
            position: absolute; right: 50px; top: 90px; z-index: 2;
        }
        .marker { width: 10px; height: 1px; margin-left: 20px; background: white; position: relative; }
        .marker p { position: absolute; color: white; font-size: 11px; top: -6px; left: 12px; margin: 0; font-family: monospace; }
        #info { position: absolute; top: 10px; left: 10px; color: white; font-size: 12px; background: rgba(0,0,0,0.6); padding: 8px 12px; border-radius: 4px; font-family: Arial; }
    </style>
</head>
<body>
    <div id="container"></div>
    <div id="legend">
        <div class="marker" style="margin-top:0"><p>10.0</p></div>
        <div class="marker" style="margin-top:48px"><p>7.5</p></div>
        <div class="marker" style="margin-top:48px"><p>5.0</p></div>
        <div class="marker" style="margin-top:48px"><p>2.5</p></div>
        <div class="marker" style="margin-top:48px"><p>0.0</p></div>
    </div>
    <div id="info"><b>Color Map FEM</b><br>Nodos: 4 | Elementos: 2<br>Min: 0.0 | Max: 10.0 mm</div>

    <script type="importmap">{"imports":{"three":"https://unpkg.com/three@0.160.0/build/three.module.js","three/addons/":"https://unpkg.com/three@0.160.0/examples/jsm/"}}</script>
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { Lut } from 'three/addons/math/Lut.js';

        // Datos (equivalente a van.state en awatif)
        const nodes = [[0,0,0],[5,0,0],[5,0,5],[0,0,5]];
        const elements = [[0,1,2],[0,2,3]];
        const values = [0, 2.5, 10, 5];

        // Setup Three.js
        const container = document.getElementById('container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a2e);

        const camera = new THREE.PerspectiveCamera(45, container.clientWidth/container.clientHeight, 0.1, 1000);
        camera.position.set(10, -12, 8);
        camera.up.set(0, 0, 1);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        container.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.target.set(2.5, 0, 2.5);
        controls.update();

        // getColorMap - crear mesh con vertex colors
        const lut = new Lut('rainbow', 512);
        lut.setMin(Math.min(...values));
        lut.setMax(Math.max(...values));

        const geometry = new THREE.BufferGeometry();
        geometry.setAttribute('position', new THREE.Float32BufferAttribute(nodes.flat(), 3));
        geometry.setIndex(new THREE.Uint16BufferAttribute(elements.flat(), 1));

        const colors = new Float32Array(nodes.length * 3);
        for (let i = 0; i < values.length; i++) {
            const c = lut.getColor(values[i]);
            colors[i*3] = c.r * 0.8;
            colors[i*3+1] = c.g * 0.8;
            colors[i*3+2] = c.b * 0.8;
        }
        geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
        geometry.computeVertexNormals();

        const mesh = new THREE.Mesh(geometry, new THREE.MeshBasicMaterial({ vertexColors: true, side: THREE.DoubleSide }));
        scene.add(mesh);

        // Wireframe
        scene.add(new THREE.LineSegments(new THREE.WireframeGeometry(geometry), new THREE.LineBasicMaterial({ color: 0xffffff })));

        // Helpers
        const grid = new THREE.GridHelper(10, 10, 0x444444, 0x333333);
        grid.rotation.x = Math.PI / 2;
        scene.add(grid);
        scene.add(new THREE.AxesHelper(2));

        // Render loop
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
@{end html:embed}

'========================================
'Estructura completa replicada de awatif-ui/color-map
'========================================
